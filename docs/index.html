<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coroot CI/CD â€” Documentation</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --text-muted: #8b949e;
    --link: #58a6ff;
    --accent: #3fb950;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    font-size: 15px;
    line-height: 1.6;
  }
  .container { max-width: 960px; margin: 0 auto; padding: 48px 24px; }
  h1 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .subtitle {
    color: var(--text-muted);
    font-size: 16px;
    margin-bottom: 48px;
  }
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 48px;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    text-decoration: none;
    color: var(--text);
    transition: border-color 0.15s, transform 0.15s;
    display: block;
  }
  .card:hover {
    border-color: var(--link);
    transform: translateY(-2px);
    text-decoration: none;
  }
  .card h2 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card p { color: var(--text-muted); font-size: 14px; }
  .card .tag {
    display: inline-block;
    background: rgba(88,166,255,0.15);
    color: var(--link);
    font-size: 11px;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 10px;
    margin-top: 12px;
  }
  .section { margin-bottom: 48px; }
  .section h2 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  th, td {
    text-align: left;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
  }
  th { color: var(--text-muted); font-weight: 500; font-size: 12px; text-transform: uppercase; }
  code {
    background: var(--surface);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', monospace;
  }
  a { color: var(--link); text-decoration: none; }
  a:hover { text-decoration: underline; }
  .flow {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    font-family: 'SFMono-Regular', Consolas, monospace;
    font-size: 13px;
    line-height: 1.8;
    color: var(--text-muted);
    overflow-x: auto;
  }
  .flow .highlight { color: var(--accent); font-weight: 600; }
  .flow .dim { color: #484f58; }
  .footer {
    border-top: 1px solid var(--border);
    padding-top: 24px;
    color: var(--text-muted);
    font-size: 13px;
    text-align: center;
  }
</style>
</head>
<body>
<div class="container">

  <h1>Coroot CI/CD</h1>
  <p class="subtitle">Auto-update pipeline for the Coroot observability stack on table.beerpub.dev</p>

  <div class="cards">
    <a class="card" href="pipeline.html">
      <h2>Pipeline Status</h2>
      <p>Real-time visualization of GitHub Actions workflow runs. See job status, duration, and history with live data from the GitHub API.</p>
      <span class="tag">D3.js &middot; Live Data</span>
    </a>
    <a class="card" href="architecture.html">
      <h2>Architecture Diagram</h2>
      <p>System architecture showing all components: VPS, Docker stack, CI/CD pipeline jobs, backups, DNS, and monitoring.</p>
      <span class="tag">D2 &middot; SVG</span>
    </a>
  </div>

  <div class="section">
    <h2>Pipeline Flow</h2>
    <div class="flow">
<span class="dim">Schedule (Mon 04:00 UTC) or Manual Trigger</span>
  <span class="dim">|</span>
  <span class="highlight">1. Check Updates</span>    <span class="dim">Compare running vs latest image digests</span>
  <span class="dim">|  -> Exit early if all images current (unless force_deploy)</span>
  <span class="dim">|</span>
  <span class="highlight">2. Backup Volumes</span>   <span class="dim">Snapshot all 8 Docker volumes (~330MB)</span>
  <span class="dim">|  -> Sync to Hetzner Storage Box (off-site)</span>
  <span class="dim">|  -> Retain last 3 backups</span>
  <span class="dim">|</span>
  <span class="highlight">3. Staging</span>           <span class="dim">Deploy to /opt/coroot-staging/, validate, tear down</span>
  <span class="dim">|  -> Abort if staging fails (production untouched)</span>
  <span class="dim">|</span>
  <span class="highlight">4. Deploy</span>            <span class="dim">docker compose pull && up -d</span>
  <span class="dim">|  -> Health check via https://table.beerpub.dev</span>
  <span class="dim">|</span>
  <span class="dim">|--[on failure]--></span> <span class="highlight">5. Rollback</span>   <span class="dim">Restore volumes, restart, verify</span>
  <span class="dim">|</span>
  <span class="highlight">6. Cleanup</span>           <span class="dim">Tear down staging, prune dangling images</span>
    </div>
  </div>

  <div class="section">
    <h2>Components</h2>
    <table>
      <thead><tr><th>Component</th><th>Role</th><th>Location</th></tr></thead>
      <tbody>
        <tr><td>Coroot</td><td>Observability platform</td><td>VPS Docker</td></tr>
        <tr><td>Prometheus</td><td>Metrics TSDB</td><td>VPS Docker</td></tr>
        <tr><td>ClickHouse</td><td>Logs/traces/profiles</td><td>VPS Docker</td></tr>
        <tr><td>Node Agent</td><td>eBPF host metrics</td><td>VPS Docker</td></tr>
        <tr><td>Cluster Agent</td><td>Metrics scraper</td><td>VPS Docker</td></tr>
        <tr><td>Caddy</td><td>Reverse proxy + TLS</td><td>VPS Docker</td></tr>
        <tr><td>GitHub Actions</td><td>CI/CD pipeline</td><td>GitHub</td></tr>
        <tr><td>Uptime Monitor</td><td>5-min health checks</td><td>GitHub Actions</td></tr>
        <tr><td>GitGuardian</td><td>Secret scanning</td><td>Pre-commit + CI</td></tr>
        <tr><td>Storage Box</td><td>Off-site backups</td><td>Hetzner</td></tr>
        <tr><td>Cloudflare</td><td>DNS</td><td>External</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Scripts</h2>
    <table>
      <thead><tr><th>Script</th><th>Purpose</th><th>Dry-run</th></tr></thead>
      <tbody>
        <tr><td><code>check-updates.sh</code></td><td>Compare running vs remote image digests</td><td><code>--dry-run</code></td></tr>
        <tr><td><code>backup-volumes.sh</code></td><td>Snapshot all Docker volumes</td><td><code>--dry-run</code></td></tr>
        <tr><td><code>deploy-staging.sh</code></td><td>Deploy staging stack &amp; validate</td><td><code>--dry-run</code></td></tr>
        <tr><td><code>deploy-production.sh</code></td><td>Pull, deploy, health check</td><td><code>--dry-run</code></td></tr>
        <tr><td><code>health-check.sh</code></td><td>Reusable HTTP health probe</td><td><code>--dry-run</code></td></tr>
        <tr><td><code>rollback.sh</code></td><td>Restore volumes from backup</td><td><code>--dry-run</code></td></tr>
        <tr><td><code>sync-remote-backup.sh</code></td><td>Sync backups to Storage Box</td><td><code>--dry-run</code></td></tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Quick Links</h2>
    <table>
      <thead><tr><th>Resource</th><th>URL</th></tr></thead>
      <tbody>
        <tr><td>Production</td><td><a href="https://table.beerpub.dev" target="_blank">https://table.beerpub.dev</a></td></tr>
        <tr><td>GitHub Repo</td><td><a href="https://github.com/atvirokodosprendimai/coroot-cicd" target="_blank">atvirokodosprendimai/coroot-cicd</a></td></tr>
        <tr><td>Actions</td><td><a href="https://github.com/atvirokodosprendimai/coroot-cicd/actions" target="_blank">Workflow Runs</a></td></tr>
        <tr><td>VPS SSH</td><td><code>ssh -i ~/.ssh/coroot-table root@91.99.74.36</code></td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    Coroot CI/CD &middot; Hetzner VPS 91.99.74.36 &middot; table.beerpub.dev
  </div>

</div>
</body>
</html>
