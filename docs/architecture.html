<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Architecture â€” Coroot CI/CD</title>
<link rel="stylesheet" href="tufte.css"/>
<style>
  body { background-color: #151515; color: #ddd; }
  code { background: #1a1a1a; padding: 0.1em 0.3em; border-radius: 2px; }
  pre > code { background: #1a1a1a; padding: 1rem; border-radius: 2px; }
  table { border-top: 2px solid #666; border-bottom: 2px solid #666; }
  th { border-bottom: 1px solid #444; font-weight: normal; padding: 0.5em 0.6em; text-align: left; }
  td { padding: 0.4em 0.6em; border: none; }
  a { color: inherit; }
  .margin-figure svg text { font-family: et-book, Palatino, Georgia, serif; }
</style>
</head>
<body>
<article>

<h1>Architecture</h1>
<p class="subtitle"><a href="index.html">&larr; Coroot CI/CD</a></p>

<section>
<p><span class="newthought">The system has three tiers.</span><label
for="mn-diagram" class="margin-toggle">&#8853;</label><input type="checkbox"
id="mn-diagram" class="margin-toggle"/><span class="marginnote"><svg class="margin-figure"
viewBox="0 0 160 340" width="160" height="340" aria-label="System topology">
<rect x="20" y="4" width="120" height="36" rx="2" fill="none" stroke="#888" stroke-width="1"/>
<text x="80" y="26" text-anchor="middle" fill="#ccc" font-size="12">GitHub Actions</text>
<line x1="80" y1="40" x2="80" y2="64" stroke="#888" stroke-width="1" marker-end="url(#ma)"/>
<text x="100" y="55" fill="#777" font-size="9" font-style="italic">SSH</text>
<rect x="10" y="64" width="140" height="120" rx="2" fill="none" stroke="#888" stroke-width="1"/>
<text x="80" y="82" text-anchor="middle" fill="#ccc" font-size="12">Hetzner VPS</text>
<rect x="24" y="92" width="112" height="82" rx="2" fill="none" stroke="#666" stroke-width="1" stroke-dasharray="3,2"/>
<text x="80" y="108" text-anchor="middle" fill="#999" font-size="10">Docker</text>
<text x="80" y="124" text-anchor="middle" fill="#888" font-size="9">Caddy &rarr; Coroot</text>
<text x="80" y="138" text-anchor="middle" fill="#888" font-size="9">Prometheus</text>
<text x="80" y="152" text-anchor="middle" fill="#888" font-size="9">ClickHouse</text>
<text x="80" y="166" text-anchor="middle" fill="#888" font-size="9">Node &amp; Cluster Agents</text>
<line x1="80" y1="184" x2="80" y2="208" stroke="#888" stroke-width="1" marker-end="url(#ma)"/>
<text x="100" y="199" fill="#777" font-size="9" font-style="italic">HTTPS</text>
<rect x="10" y="208" width="140" height="36" rx="2" fill="none" stroke="#888" stroke-width="1"/>
<text x="80" y="230" text-anchor="middle" fill="#ccc" font-size="12">table.beerpub.dev</text>
<line x1="80" y1="244" x2="80" y2="264" stroke="#888" stroke-width="1" stroke-dasharray="3,2"/>
<text x="100" y="257" fill="#777" font-size="9" font-style="italic">DNS</text>
<rect x="20" y="264" width="120" height="36" rx="2" fill="none" stroke="#888" stroke-width="1"/>
<text x="80" y="286" text-anchor="middle" fill="#ccc" font-size="12">Cloudflare</text>
<line x1="150" y1="160" x2="150" y2="316" stroke="#888" stroke-width="1" stroke-dasharray="3,2"/>
<line x1="150" y1="316" x2="130" y2="316" stroke="#888" stroke-width="1" marker-end="url(#ma)"/>
<text x="158" y="240" fill="#777" font-size="9" font-style="italic" transform="rotate(90,158,240)">rsync</text>
<rect x="20" y="300" width="120" height="36" rx="2" fill="none" stroke="#888" stroke-width="1"/>
<text x="80" y="322" text-anchor="middle" fill="#ccc" font-size="12">Storage Box</text>
<defs><marker id="ma" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto"><path d="M 0 1 L 8 5 L 0 9 z" fill="#888"/></marker></defs>
</svg>
System topology. The full <a href="architecture.d2">D2 source</a>
contains all node-level connections.</span>
GitHub Actions deploys over SSH to a Hetzner VPS running six Docker containers.
Users reach the stack through Cloudflare DNS and Caddy's reverse proxy at
<code>https://table.beerpub.dev</code>. Backups sync to a Hetzner Storage Box
via rsync on port 23.</p>

<p>The production Docker stack consists of six services, all communicating within
a single Docker network. Only Caddy binds to host ports 80 and 443; the remaining
five services use <code>expose:</code> and are reachable only through Caddy or
within the container network.</p>

<table>
  <thead>
    <tr><th>Service</th><th>Image</th><th>Role</th></tr>
  </thead>
  <tbody>
    <tr><td>Caddy</td><td><code>caddy:2</code></td><td>Reverse proxy, auto-TLS</td></tr>
    <tr><td>Coroot</td><td><code>ghcr.io/coroot/coroot</code></td><td>Observability platform</td></tr>
    <tr><td>Prometheus</td><td><code>prom/prometheus:v2.53.5</code></td><td>Metrics storage</td></tr>
    <tr><td>ClickHouse</td><td><code>clickhouse-server:24.3</code></td><td>Logs, traces, profiles</td></tr>
    <tr><td>Node Agent</td><td><code>ghcr.io/coroot/coroot-node-agent</code></td><td>eBPF host metrics</td></tr>
    <tr><td>Cluster Agent</td><td><code>ghcr.io/coroot/coroot-cluster-agent</code></td><td>Metrics scraper</td></tr>
  </tbody>
</table>
</section>

<section>
<h2>Design Decisions</h2>

<p><span class="newthought">Services use <code>expose:</code></span> rather than
<code>ports:</code>.<label for="sn-expose" class="margin-toggle sidenote-number"></label><input
type="checkbox" id="sn-expose" class="margin-toggle"/><span class="sidenote">This was the root
cause of the first three pipeline test failures. Health check scripts attempted
<code>curl http://localhost:8080</code> from the host, which returned connection refused because
the port was only open inside the Docker network. See the
<a href="https://github.com/atvirokodosprendimai/coroot-cicd/blob/main/POSTMORTEM.md">postmortem</a>
for the full incident timeline and five-whys analysis.</span>
Only Caddy binds to the host network on ports 80 and 443. All other services are reachable
only within the Docker network or through Caddy's reverse proxy. This reduces the attack
surface to a single entry point with TLS termination.</p>

<p><span class="newthought">The external Caddy endpoint</span> at
<code>https://table.beerpub.dev</code> is the sole authoritative health check. Internal probes
via <code>docker exec</code> proved unreliable for Coroot specifically&mdash;the container's
<code>wget</code> binary did not behave as expected. The pipeline probes the external endpoint
with three retries and treats HTTP 200 as definitive proof of health, regardless of Docker's
own healthcheck status.</p>

<p><span class="newthought">Backups are both local and remote.</span> Local backups at
<code>/opt/coroot/backups/</code> enable fast rollback under three minutes. Remote backups
on a Hetzner Storage Box provide disaster recovery if the VPS disk fails. The sync uses rsync
over SSH on port 23, which is Hetzner's standard SSH port for Storage Boxes.<label for="sn-port23"
class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-port23"
class="margin-toggle"/><span class="sidenote">Hetzner Storage Boxes do not provide a shell.
They only support SFTP, rsync, and SCP. The remote backup script uses SFTP for directory
listing and pruning, and rsync for the actual data transfer. The initial implementation
attempted to use <code>ssh ... echo 'Connection OK'</code> for connectivity testing, which
returned &ldquo;Command not found&rdquo; because there is no shell.</span></p>
</section>

</article>
</body>
</html>
