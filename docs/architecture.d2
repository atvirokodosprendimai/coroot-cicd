direction: right

github: GitHub {
  repo: Git Repository
  actions: GitHub Actions {
    check: 1. Check Updates
    backup: 2. Backup
    staging: 3. Staging
    deploy: 4. Deploy
    rollback: 5. Rollback
    cleanup: 6. Cleanup

    check -> backup -> staging -> deploy -> cleanup
    deploy -> rollback: on failure {
      style.stroke-dash: 3
    }
    rollback -> cleanup
  }
  scan: GitGuardian {
    style.stroke-dash: 3
  }
  uptime: Uptime Monitor {
    style.stroke-dash: 3
  }

  repo -> actions: triggers
  repo -> scan: pre-commit
}

vps: Hetzner VPS {
  docker: Docker {
    stack: Production (/opt/coroot) {
      caddy: Caddy
      coroot: Coroot
      prometheus: Prometheus
      clickhouse: ClickHouse
      node-agent: Node Agent
      cluster-agent: Cluster Agent

      caddy -> coroot: reverse proxy
      coroot -> prometheus
      coroot -> clickhouse
      node-agent -> coroot: eBPF
      cluster-agent -> prometheus: scrape
    }

    staging: Staging {
      style.stroke-dash: 3
    }
  }

  backups: Local Backups {
    shape: cylinder
  }

  docker -> backups: snapshots
}

external: External {
  storagebox: Storage Box {
    shape: cylinder
  }
  dns: Cloudflare DNS
  endpoint: table.beerpub.dev {
    style.bold: true
  }
}

users: Users {
  shape: cloud
}

# Connections
github.actions -> vps.docker: SSH
github.actions -> vps.docker.staging: validate {
  style.stroke-dash: 3
}
github.uptime -> external.endpoint: probe {
  style.stroke-dash: 3
}

vps.backups -> external.storagebox: rsync

external.dns -> external.endpoint: A record
external.endpoint -> vps.docker.stack.caddy: HTTPS

users -> external.endpoint: HTTPS
